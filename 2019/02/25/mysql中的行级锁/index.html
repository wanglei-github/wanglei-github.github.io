<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>mysqlä¸­çš„è¡Œçº§é” | Code Work Life | æ€è€ƒå¾ˆé‡è¦ï¼Œè¡ŒåŠ¨æ›´é‡è¦</title>

  
  <meta name="author" content="wanglei">
  

  
  <meta name="description" content="gapé”å’Œnext-keyçš„æ„ä¹‰è¯»è¿‡ä¸€äº›å…³äºmysqlçš„åšæ–‡ï¼Œéƒ½æ²¡æœ‰ææ¸…æ¥šä»€ä¹ˆæ˜¯gapé”ï¼Œä»€ä¹ˆnext-keyé”ã€‚ç›´åˆ°çœ‹åˆ°ä¸€äº›å®˜æ–¹æ–‡æ¡£ï¼Œæ‰å¯¹è¿™äº›é”æœ‰äº†æ›´æ¸…æ¥šçš„è®¤è¯†ã€‚å®˜æ–¹ç›´é€šé—¨
gap lockså¼•ç”¨å®˜æ–¹æ–‡æ¡£

A gap lock is a lock on a gap between index r">
  

  
  
  <meta name="keywords" content="mysql,innodb,å®˜æ–¹æ–‡æ¡£,gap locks,next-key locks,mysql 5.7">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="mysqlä¸­çš„è¡Œçº§é”"/>

  <meta property="og:site_name" content="Code Work Life"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Code Work Life" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">Code Work Life</a>
    </h1>
    <p class="site-description">æ€è€ƒå¾ˆé‡è¦ï¼Œè¡ŒåŠ¨æ›´é‡è¦</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">ä¸»é¡µ</a></li>
      
        <li><a href="/archives">å½’æ¡£</a></li>
      
        <li><a href="/about">å…³äº</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>mysqlä¸­çš„è¡Œçº§é”</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2019/02/25/mysqlä¸­çš„è¡Œçº§é”/" rel="bookmark">
        <time class="entry-date published" datetime="2019-02-25T09:28:37.000Z">
          2019-02-25
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="gapé”å’Œnext-keyçš„æ„ä¹‰"><a href="#gapé”å’Œnext-keyçš„æ„ä¹‰" class="headerlink" title="gapé”å’Œnext-keyçš„æ„ä¹‰"></a>gapé”å’Œnext-keyçš„æ„ä¹‰</h2><p>è¯»è¿‡ä¸€äº›å…³äºmysqlçš„åšæ–‡ï¼Œéƒ½æ²¡æœ‰ææ¸…æ¥šä»€ä¹ˆæ˜¯gapé”ï¼Œä»€ä¹ˆnext-keyé”ã€‚ç›´åˆ°çœ‹åˆ°ä¸€äº›å®˜æ–¹æ–‡æ¡£ï¼Œæ‰å¯¹è¿™äº›é”æœ‰äº†æ›´æ¸…æ¥šçš„è®¤è¯†ã€‚<a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-locking.html" target="_blank" rel="noopener">å®˜æ–¹ç›´é€šé—¨</a></p>
<h3 id="gap-locks"><a href="#gap-locks" class="headerlink" title="gap locks"></a>gap locks</h3><p>å¼•ç”¨å®˜æ–¹æ–‡æ¡£</p>
<blockquote>
<p>A gap lock is a lock on a gap between index records, or a lock on the gap before the first or after the last index record</p>
</blockquote>
<p>è¿™å¥æ˜¯ä¸€ä¸ªå®šä¹‰ï¼Œæˆ‘ä»¬èƒ½äº†è§£åˆ°ï¼Œgapé”æ˜¯ä½œç”¨åœ¨ index recordså³ç´¢å¼•æ•°æ®ä¸Šã€‚ä½†å¯¹äºå®é™…åº”ç”¨è¿˜ä¸æ˜¯å¾ˆé€å½»ï¼Œä½†åé¢çš„æ–‡æ¡£ä¸¾äº†ä¸€ä¸ªä¾‹å­</p>
<blockquote>
<p>For example, SELECT c1 FROM t WHERE c1 BETWEEN 10 and 20 FOR UPDATE; prevents other transactions from inserting a value of 15 into column t.c1, whether or not there was already any such value in the column, because the gaps between all existing values in the range are locked.</p>
</blockquote>
<p>æ¯”è¾ƒé‡è¦çš„ä¸€éƒ¨åˆ†æ˜¯ <strong><em>prevents other transactions from inserting a value of 15 into column t.c1</em></strong></p>
<p>å…¶ä¸­<strong><em>inserting</em></strong> è¿™ä¸ªåŠ¨è¯ï¼Œè¡¨æ˜äº†gapé”çš„æ„ä¹‰ã€‚gap locksæ˜¯ä¸ºäº†é˜»æ­¢å…¶ä»–äº‹åŠ¡çš„insertæ“ä½œã€‚</p>
<h3 id="next-key-locks"><a href="#next-key-locks" class="headerlink" title="next-key locks"></a>next-key locks</h3><p>åŒæ ·å¼•ç”¨å®˜æ–¹æ–‡æ¡£</p>
<blockquote>
<p>A next-key lock is a combination of a record lock on the index record and a gap lock on the gap before the index record.</p>
</blockquote>
<p>é€šè¿‡ä¸Šé¢çš„æ–‡æ¡£ï¼Œæˆ‘ä»¬èƒ½ç†è§£åˆ°ï¼Œnext-key lockså®é™…ä¸Šæ˜¯ä¸¤ç§é”çš„ç»„åˆã€‚è¡¨æ˜å®ƒæ—¢æœ‰record lockçš„ç‰¹æ€§ï¼Œä¹Ÿæœ‰ gap lock çš„ç‰¹æ€§ã€‚<br>é‚£å®ƒåˆ°åº•æ˜¯å¦‚ä½•èµ·ä½œç”¨çš„å‘¢?</p>
<blockquote>
<p>A next-key lock on an index record also affects the â€œgapâ€ before that index record</p>
</blockquote>
<blockquote>
<p>that is, a next-key lock is an index-record lock plus a gap lock on the gap preceding the index record.</p>
</blockquote>
<p>é¦–å…ˆ next-keyæ˜¯é’ˆå¯¹ç´¢å¼•æ•°æ®çš„keyï¼Œå…¶æ¬¡ï¼Œå®ƒè¿˜å¯¹è¯¥ç´¢å¼•è®°å½•çš„ä¹‹å‰çš„æ•°æ®æœ‰ gap locksçš„ä½œç”¨ã€‚</p>
<p>æ€ä¹ˆç†è§£å‘¢ï¼Ÿå®˜æ–¹æ–‡æ¡£æ˜¯è¿™ä¹ˆè¯´çš„</p>
<blockquote>
<p>If one session has a shared or exclusive lock on record R in an index, another session cannot insert a new index record in the gap immediately before R in the index order.</p>
</blockquote>
<p>ä¸¾ä¸ªğŸŒ°ï¼Œå‡è®¾æœ‰è¡¨childï¼Œå…¶è¡¨ç»“æ„ä¸ºï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `child` (</span><br><span class="line">  `id` int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(22) DEFAULT NULL,</span><br><span class="line">  `age` int(11) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  KEY `age` (`age`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT DEFAULT CHARSET=utf8mb4;</span><br></pre></td></tr></table></figure></p>
<p>å‡è®¾æœ‰å¦‚ä¸‹æ•°æ®</p>
<table>
<thead>
<tr>
<th style="text-align:left">id</th>
<th style="text-align:center">name</th>
<th style="text-align:right">age</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td style="text-align:center">jack</td>
<td style="text-align:right">23</td>
</tr>
<tr>
<td style="text-align:left">2</td>
<td style="text-align:center">rose</td>
<td style="text-align:right">19</td>
</tr>
</tbody>
</table>
<p>æˆ‘ä»¬ageåˆ—ä¸Šæ˜¯æœ‰æ™®é€šç´¢å¼•çš„ã€‚é‚£ä¹ˆæ ¹æ®next-key locksçš„å®šä¹‰ï¼Œå…¶å®æˆ‘ä»¬ä¼šæœ‰å¦‚ä¸‹çš„ next-key locksé”</p>
<table>
<thead>
<tr>
<th style="text-align:left">next-key locks</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">(negative infinity, 19]</td>
</tr>
<tr>
<td style="text-align:left">(19, 23]</td>
</tr>
<tr>
<td style="text-align:left">(23, positive infinity)</td>
</tr>
</tbody>
</table>
<p>æ‰€ä»¥ï¼Œå½“æœ‰ä¸¤ä¸ªäº‹åŠ¡Aã€BåŒæ—¶æ‰§è¡Œï¼Œä½†Aæ‰§è¡Œè¯­å¥åœ¨Bä¹‹å‰ã€‚<br>å‡è®¾Aä¸º<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update child set name=&quot;Lucy&quot; where age=19;</span><br></pre></td></tr></table></figure></p>
<p>Bä¸º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert child values(null,&quot;Lily&quot;,8);</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆæ ¹æ®å®šä¹‰ï¼Œmysqlä¼šé”ä½ (negative infinity, 19]è¿™å—çš„æ•°æ®ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´Bäº‹åŠ¡å µå¡ã€‚å› ä¸º 8 åœ¨ (negative infinity, 19]ä¸­ã€‚ä½†æ˜¯å¦‚æœæ˜¯<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert child values(null,&quot;Lily&quot;,23);</span><br></pre></td></tr></table></figure></p>
<p>å°±å¯ä»¥ã€‚</p>
<p>æˆ‘ä»¬å†çœ‹ä¸‹å®˜æ–¹æ–‡æ¡£</p>
<blockquote>
<p>InnoDB uses next-key locks for searches and index scans, which prevents phantom rows</p>
</blockquote>
<p>é€šè¿‡ä¸Šé¢æˆ‘ä»¬èƒ½ç†è§£åˆ°next-keyå®é™…æ˜¯ä¸ºäº†è§£å†³<strong><em>å¹»è¯»</em></strong>é—®é¢˜ï¼Œ<br>é‚£ä¹ˆå®é™…ä¾ç„¶æ˜¯é˜»æ­¢äº†å…¶ä»–äº‹åŠ¡çš„<strong><em>insert</em></strong>æ“ä½œã€‚</p>
<p><strong><em>å¤§å®¶æ³¨æ„ï¼Œä»¥ä¸Šä¾‹å­ï¼Œéƒ½æ˜¯åœ¨æ™®é€šç´¢å¼•ä¸Šçš„æ“ä½œï¼Œå¦‚æœä½ æ“ä½œçš„åˆ—æ˜¯æœ‰uniqueç´¢å¼•æˆ–è€…æ˜¯ä¸»é”®ç´¢å¼•å¹¶ä¸”é”å®šçš„æ•°æ®æ˜¯è¡¨æœ‰çš„ï¼Œé‚£ä¹ˆéƒ½ä¸ä¼šæœ‰gap locksçš„ç‰¹æ€§ï¼ŒåŠé€€åŒ–ä¸ºè¡Œé”</em></strong><br><strong><em>è‹¥æ‰§è¡Œçš„æ¡ä»¶ä½œç”¨åœ¨å”¯ä¸€ç´¢å¼•æˆ–è€…ä¸»é”®ç´¢å¼•æ—¶ï¼Œè¯¥æ¡ä»¶å®é™…ä¸å­˜åœ¨è¡¨é‡Œï¼Œé‚£ä¹ˆä¾ç„¶ä¼šé”ä½è¯¥æ¡ä»¶çš„å·¦å³ä¸¤ä¸ªåŒºé—´</em></strong></p>
<blockquote>
<p>Gap locking is not needed for statements that lock rows using a unique index to search for a unique row. (This does not include the case that the search condition includes only some columns of a multiple-column unique index; in that case, gap locking does occur.) </p>
</blockquote>
<p>æ‰€ä»¥ï¼Œåˆé€‚ç´¢å¼•ï¼Œä¸ä»…èƒ½ä¿æŒæŸ¥è¯¢æ•ˆç‡ï¼Œä¹Ÿå¯ä»¥ä¿è¯è¡Œçº§åˆ«çš„ç²¾ç¡®æ€§ã€‚</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/mysql/">mysql</a><a href="/tags/innodb/">innodb</a><a href="/tags/å®˜æ–¹æ–‡æ¡£/">å®˜æ–¹æ–‡æ¡£</a><a href="/tags/gap-locks/">gap locks</a><a href="/tags/next-key-locks/">next-key locks</a><a href="/tags/mysql-5-7/">mysql 5.7</a>
    </span>
    

    </div>

    
  </div>
</article>


    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2020 wanglei
    
  </p>
</footer>
    
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-83609983-2', 'auto');
    ga('send', 'pageview');

</script>

  </div>
</div>
</body>
</html>